stages:
  - build
  - test
  - stop

job1:
  stage: build
  script: |
    # install
    sudo apt update -yq
    sudo apt install -yq ca-certificates
    echo "deb [trusted=yes] https://packages.twingate.com/apt/ /" | sudo tee /etc/apt/sources.list.d/twingate.list
    sudo apt update -yq
    sudo apt install -yq twingate
    # setup and start
    echo "ewogICJ2ZXJzaW9uIjogIjEiLAogICJuZXR3b3JrIjogImNoZW5iLnR3aW5nYXRlLmNvbSIsCiAgInNlcnZpY2VfYWNjb3VudF9pZCI6ICJmMTJiZWJjMi01OGYxLTQzOTYtOWY5NS0xMGYwZTJiNTU2NzIiLAogICJwcml2YXRlX2tleSI6ICItLS0tLUJFR0lOIFBSSVZBVEUgS0VZLS0tLS1cbk1JR0hBZ0VBTUJNR0J5cUdTTTQ5QWdFR0NDcUdTTTQ5QXdFSEJHMHdhd0lCQVFRZ3NGMjVEOEh3a3QyaC81VU9cbjF5TXFFOGM2VGNZa3lsanpZc1ZLT3NVZ1M1S2hSQU5DQUFRT1o2c1ZPVVJTamtBTGVyTHdEWlI0Z1Jja0FsSzhcbjNZN1RsN1V6ZFB5R0ZKcXFVSzZ1L2RXdE1UVU1NeWw3c3A2R3lQMXVJTGV5OTVBQzFYNGZ3YUFvXG4tLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tIiwKICAia2V5X2lkIjogImtFd0JmeENJOUhMRGZrblQwQ2NESXhvRl9pbHFlSzc4WkFHMUFucDBsa3ciLAogICJleHBpcmVzX2F0IjogIjIwMjMtMTAtMTdUMTQ6NTQ6MDErMDA6MDAiLAogICJsb2dpbl9wYXRoIjogIi9hcGkvdjIvaGVhZGxlc3Nfbm9kZS9sb2dpbiIKfQ==" | base64 --decode | sudo twingate setup --headless=-
    sudo twingate start
    # collect logs
    sudo journalctl -u twingate --no-pager | tail -n 20

job2:
  stage: test
  script: |
    # test protected resource
    curl -v -m 10 "http://172.30.2.229:3000" > /dev/null
    # test public resource
    curl -v -m 10 http://twingate.com > /dev/null

job3:
  stage: stop
  script: |
    # stop
    sudo twingate stop
    # test public resource after stop
    curl -v -m 10 http://twingate.com > /dev/null

